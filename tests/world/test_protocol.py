import json

import construct
import trio
import os

from wlink.guid import Guid
from wlink.world import WorldClientProtocol, WorldServerProtocol
from wlink.world.packets import Opcode, ClientHeader, Expansion, AuthResponse, Gender, Race, CombatClass, \
	CMSG_GUILD_INFO_TEXT, CMSG_AUCTION_LIST_ITEMS, SMSG_NAME_QUERY_RESPONSE, SMSG_AUTH_RESPONSE, NameInfo, \
	CMSG_PING, SMSG_ADDON_INFO, CMSG_GET_MAIL_LIST, CMSG_AUCTION_LIST_OWNER_ITEMS, CMSG_AUCTION_LIST_PENDING_SALES, \
	CMSG_AUCTION_PLACE_BID, CMSG_AUCTION_SELL_ITEM, AuctionSellData, CMSG_GUILD_ROSTER, CMSG_WHO
from wlink.world.packets.b12340 import parse

logins_filename = os.environ.get('WLINK_TEST_CREDS')
with open(logins_filename) as f:
	test_servers = json.load(f)

ac_login = test_servers['acore']['account']


async def find_client_packets():
	parser = parse.WorldClientPacketParser()
	data = bytes.fromhex(
		'0000000000675f54d1e65a382bc343730cac001011dcaa4c0204a1a45a3e87c4b31bed69002033eb55010720b79b3e2a87823cab8f5e0030bfbf8eb10108535006298b5badbd5b530040e1895e644b8979604517f018fa18b3b900509bb764cbcb33bed1e3db2ccc17bac1a20060cb062e86cdd40166742b495c252c468700706a1a3e7d18e2000e702000005b0e70200000ee0e702000006a06d0460a90870ad0e50ba05804d02a0310970fe0c90790b90760640ed020ff04000008c0300000ff0ff0ff0ff0e70200000ca0a502102901c05706001d03f0440d00dc0d707a02607704306a0ed04106401e0a70eb0420480fd0130240350eb0630830450c0500000000500000000000000050000000070000000000000005000000008000000000000000cc0100000005000000001000000000000000540000000100000006a0200000100000000000000089000000066000000010000000cc010000010bf020000000cd0200000110200000ce0100000e301000002000000070000000b00000000840200000d302000009602000006e0300000fe0300000fd0300000470400000af030000000001704000007f020000050000000000000001704000007f02000005000000000000000210300000ff0170400000960200000910300000000000009f0e003e0140c9000000010100000000000009f0e003e0140610e2090c605c0f50200440660ac0bc0420280d707904000000000095000000020000000ff0ff0ff0ff05802d05006507206c0905604505202003302e03002e03902305204505602007203403003202304704302003403103303703602304c04f04302006506e05505302304d04f044020031031031031031031031031031031030030031031031030000f60400000ee00000001010000000000000a50e003e0140610e2090c605c0f50200440660ac0bc0420280d7079040000000000b40000000ba0a0000017040000095000000030000000ff0ff0ff0ff04404204d07603402d0560650720904806902100095000000030000000ff0ff0ff0ff05802d05006507206c0905604505202003302e03002e03902305204505602007203403003202304704302003403103703003302304c04f04302006506e05505302304d04f04402003103103103103103103103103103103003003103103103000050000000030000000000000000820100000330bb030ff093000300f10820100000190bb0308203e000300f10820100000160bb0308503e000300f10820100000980510105c03d000300f10820100000480370109805000300f10820100000430370101701000300f10820100000400370101e018000300f108201000004b0bb030b2094000300f108201000002d0bb0302b093000300f10820100000170bb030e903e000300f10820100000510bb030b5095000300f10820100000e10370105401a000300f10820100000df0370109705000300f1082010000034037010e201000300f10820100000640370109305000300f10820100000b80370109405000300f1095000000030000000ff0ff0ff0ff04404204d07603402d056065072090340340340320903402e0350320903402e0350320906506e0550530009700000001000000010004706506e06507206106c02002d02005307406f07206d07706906e064020043069074079000009700000002000000010005407206106406502002d0200430690740790000097000000016000000010004c06f06306106c04406506606506e07306502002d02005307406f07206d07706906e064020043069074079000009700000001a000000010004c06f06f06b06906e06704606f07204707206f07507000000d01000002001f0da000000010100000000000006d0ee03e0140610e2090c605c0f50200440660ac0bc04204d08d072040000000000da000000010100000000000007c0ee03e0140610e2090c605c0f50200440660ac0bc04201b0306b040000000000da000000010100000000000008d0ee03e0140610e2090c605c0f50200440660ac0bc0420d5074060040000000000da000000010100000000000009e0ee03e0140610e2090c605c0f50200440660ac0bc0420240a2052040000000000da00000001010000000000000b00ee03e0140610e2090c605c0f50200440660ac0bc0420bb0cc042040000000000da00000001010000000000000c00ee03e0140610e2090c605c0f50200440660ac0bc0420fc0b6032040000000000da00000001010000000000000d10ee03e0140610e2090c605c0f50200440660ac0bc04203c0a1022040000000000da00000001010000000000000e10ee03e0140610e2090c605c0f50200440660ac0bc0420dd04d014040000000000da00000001010000000000000f30ee03e0140610e2090c605c0f50200440660ac0bc0420e903e09040000000000da0000000101000000000000040ef03e0140610e2090c605c0f50200440660ac0bc04206007401040000000000da00000001010000000000000260ef03e0140610e2090c605c0f50200440660ac0bc042000d30f203f000000000da00000001010000000000000ce0f003e0140610e2090c605c0f50200440660ac0bc0420880ba0e003f000000000da00000001010000000000000de0f003e0140610e2090c605c0f50200440660ac0bc0420be0220cf03f000000000da00000001010000000000000ee0f003e0140610e2090c605c0f50200440660ac0bc0420ac08d0bf03f000000000da00000001010000000000000fe0f003e0140610e2090c605c0f50200440660ac0bc0420520fb0b103f000000000da00000001010000000000000e0f103e0140610e2090c605c0f50200440660ac0bc0420a60e90a403f000000000da000000010100000000000001e0f103e0140610e2090c605c0f50200440660ac0bc04201004b08e03f000000000da000000010100000000000003e0f103e0140610e2090c605c0f50200440660ac0bc0420f505806f03f000000000da000000010100000000000004e0f103e0140610e2090c605c0f50200440660ac0bc0420e603205303f000000000da000000010100000000000005e0f103e0140610e2090c605c0f50200440660ac0bc0420b0603203f000000000da000000010100000000000006e0f103e0140610e2090c605c0f50200440660ac0bc0420c00d30c03f000000000da000000010100000000000007e0f103e0140610e2090c605c0f50200440660ac0bc0420a20450d103e000000000da000000010100000000000008f0f103e0140610e2090c605c0f50200440660ac0bc0420c40e308803e000000000da00000001010000000000000b00f103e0140610e2090c605c0f50200440660ac0bc0420180dc0e103d000000000b500000001010100000000000260f303e0140610e2090c605c0f50200440660ac0bc0420990b00c103d000000000da00000001010100000000000b90f303e0140490de090c606d0fc0200440150b10bc0420540de08403e0000000009700000000000000000004307206205a03203003203004903100000da00000001010100000000000da0f303e0140670dd090c60d2000210440150b10bc0420a80580df03e000000000da00000001010100000000000fb0f303e0140940dc090c6078070210440e10af0bc0420ab0cf0903f000000000b800000001010500000000000990f503e0140ca0d2090c60b606a0210440140b40bc04202f0d901003f000000000ba000000010101000000000006c0f603e0140810d1090c60f80c60210440d20d20bc04202f0d901003f0000000003a02000003c087010130fc020100f108104000003c087010130fc020100f10ee00000001010100000000000600f803e0140b00c5090c60e03f02204405c0e30bc04202f0d901003f000000000b700000001010000000000000ae0f903e0140cb0bd090c604608f0220440c30a0bd04202f0d901003f00000000091030000010000000410503f01403802000003c087010130fc020100f105006f06e074000610790790000029000000000000000002004e0000000000000000000000000000000170400000890000000da00000001010000000000000c01903f0140cb0bd090c604608f0220440c30a0bd0420f70680eb03e000000000da000000010100000000000002c01903f0140cb0bd090c604608f0220440c30a0bd0420890c0a703e000000000b5000000010101000000000002c01903f0140cb0bd090c604608f0220440c30a0bd0420890c0a703e000000000da000000010101000000000005d01903f01407a0bc090c60660950220440cb0e0bd0420f607505503e000000000da000000010101000000000009d01903f0140b50ba090c60cf099022044070120bd0420320d10d903d000000000ee000000010101000000000009101b03f0140c90ac090c60960b10220440b30250bd0420320d10d903d000000000da00000001010100000000000e201b03f0140890aa090c60cc0b50220440400290bd04209609606d03e000000000da00000001010100000000000f301b03f0140120aa090c608c0b702204407e02a0bd04206a0170af03e000000000da000000010101000004000001301c03f01403e0a9090c60fa0bc0220440820650bd0420ab0cf0903f0000000007e02a0bd0420da000000010101000000000003501c03f0140720a8090c604a0c50220440760cb0bd04203e0ff02c03f000000000da00000001010100000400000d901c03f0140fd0a4090c609e0f502204405104f0bf04206202904c03f000000000230a60be0420da00000001010100000000000f901c03f0140620a4090c602a0002304405607a0bf04207204f06803f000000000da00000001010100000000000df01d03f0140a40a0090c6070540230440de0640c00420d503e08503f000000000da000000010101000000000001001e03f0140ff09f090c60690670230440100640c00420430d509503f000000000da000000010101000000000004301e03f01407e09f090c60c207c0230440100640c00420ef0e60a203f000000000da000000010101000000000006d01f03f01404a09d090c60850fd0230440100640c00420530fb0b103f000000000da000000010101000000000008e01f03f01402709d090c60220c0240440100640c00420cb0130c403f000000000da00000001010100000000000ae01f03f01402809d090c607601a0240440100640c004204d0ae0d703f000000000b900000001010900000000000ae01f03f01402809d090c607601a0240440100640c004204d0ae0d703f000000000da00000001010900000000000ce01f03f01409f09c090c60f50250240440100640c004205f0430e703f000000000da00000001010900000000000e02003f0140c309b090c601d03f0240440100640c00420670560f503f000000000da000000010109000000000003e02003f01403a09b090c60d50520240440100640c00420903401040000000000da000000010109000000000007002003f0140d309a090c60450680240440100640c00420ee0ff09040000000000da00000001010900000000000a302003f01409909a090c60d007e0240440100640c00420c4088010040000000000da000000010109000000000006e02103f01402b09a090c607b0d902404403c0640c00420a01701b040000000000ba000000010101000000000006e02103f01402b09a090c607b0d902404403c0640c00420a01701b040000000000da000000010101000000000007f02103f01408709a090c607e0de02404403c0640c00420e5060022040000000000da000000010101000000000008f02103f0140e509a090c60910e202404403c0640c004201202a029040000000000da00000001010100000000000af02103f0140b309b090c60d00e802404403c0640c004201078033040000000000bb000000010101010000000000d102103f01409b09c090c60830ed02404403c0640c004201a03d037040000000000d80930fe0c0090230760bf060c008c03e00000e00400ee0000000101010100000000006802203f0140410a0090c60560fe0240440be05a0c204201a03d0370400970000000d80930fe0c0090230760bf060c008c03e00000e00400b400000004f01600000ee0000000101010100000000005c02403f0140440ad090c60003a0250440f60920c204202e04103a04008b0200000d80930fe0c0090230760bf060c008c03e00000e00400c9000000010101000000000006202503f01404e0b4090c603705a0250440790d80be04202e04103a0400910300000b900000001010900000000000a002503f0140ff0b5090c60960600250440790d80be04202e04103a0400910300000b700000001010800000000000002603f0140690b7090c60290850250440790d80be04202e04103a0400910300000ba00000001010000000000000c02703f0140b00b5090c6060fa0250440790d80be04202e04103a04009103000003d010000059037010f022000300f1055020000059037010f022000300f1064020000059037010f022000300f10000000000000000059020000059037010f022000300f10000000008f040000059037010f022000300f10910300000200000005d02c03f0140f6040000058020000059037010f022000300f1000000000000000ff0ff0ff0ff0ff0ff0ff0ff0ff0ff0ff0ff0ff0ff0ff0ff0000070100000105000600090108000300055020000059037010f022000300f1064020000059037010f022000300f10000000000000000059020000059037010f022000300f10000000008f040000059037010f022000300f1058020000059037010f022000300f1000000000000000ff0ff0ff0ff0ff0ff0ff0ff0ff0ff0ff0ff0ff0ff0ff0ff000007010000010500060009010800030005a020000059037010f022000300f1010000000300501d021058020000059037010f022000300f10000000007406f07506706802006807506e06b02006f0660200620720650610640000000ff0ff0ff0ff0ff0ff0ff0ff0ff0ff0ff0ff0ff0ff0ff0ff00000701000001050006000901080003000910300000300000007705303f014056020000059037010f022000300f1010000000ec0c0000000000040000000000e002e000002004e00000400b00000910300000400000008507a03f0140f60400000e702000004c04c0800ad08204e0a101d05206103506308b0bd0570610e20460c00a70990b20ca02408006d0d807707709f0c70670eb0b50390220a40b00d0056020000059037010f022000300f1010000000ec0c00000000000400100000008404e000006005b03000a0050000059020000059037010f022000300f10000000008f040000059037010f022000300f10170400000910300000500000009f0a103f014058020000059037010f022000300f10000000007406f07506706802006807506e06b02006f0660200620720650610640000000ff0ff0ff0ff0ff0ff0ff0ff0ff0ff0ff0ff0ff0ff0ff0ff00000701000001050006000901080003000da00000001010000000000000860a603f0140b00b5090c6060fa0250440790d80be04206a04d0430400910300000da00000001010000000000000960a603f0140b00b5090c6060fa0250440790d80be0420b509c04e0400910300000da00000001010000000000000a70a603f0140b00b5090c6060fa0250440790d80be04201e07205e0400910300000da00000001010000000000000b80a603f0140b00b5090c6060fa0250440790d80be0420440b0710400910300000da00000001010000000000000c90a603f0140b00b5090c6060fa0250440790d80be0420b70320820400910300000da00000001010000000000000da0a603f0140b00b5090c6060fa0250440790d80be0420cc0df08b0400910300000da00000001010000000000000eb0a603f0140b00b5090c6060fa0250440790d80be04202e04b0940400910300000da00000001010000000000000fc0a603f0140b00b5090c6060fa0250440790d80be04202f0f409a0400910300000da00000001010000000000000d0a703f0140b00b5090c6060fa0250440790d80be04209f0f909e0400910300000b500000001010100000000000400a703f0140b00b5090c6060fa0250440790d80be0420ff0bb0a00400910300000da000000010101000000000007e0a803f0140ea0b2090c60ad0720250440790d80be0420480620a50400910300000da000000010101000000000009f0a803f0140790b2090c60b20650250440790d80be0420c70aa0ab0400910300000da00000001010100000000000af0a803f0140330b2090c6000600250440790d80be0420b404f0af0400910300000da00000001010100000000000c00a803f0140df0b1090c608305a0250440790d80be0420760d40b20400910300000da00000001010100000000000e00a803f0140290b1090c60c70510250440790d80be04203d01a0b70400910300000da00000001010100000000000a80a903f0140570ac090c60280240250440790d80be0420d207e0ba0400910300000da00000001010100000000000c90a903f0140800ab090c602501e0250440790d80be0420460450bf0400910300000da00000001010100000000000eb0a903f0140950aa090c602a01a0250440790d80be04208f0eb0c30400910300000bb000000010101010000000000d00aa03f0140370a4090c60250e0250440790d80be04209906d0c5040000000000d80930fe0c00e805907e03f0890100e80bd00000e00400ee000000010101010000000000450ab03f0140970a3090c60880100250440700710c004209906d0c50400750000000d80930fe0c00e805907e03f0890100e80bd00000e00400b400000004f01600000da000000010101010000000000c60ab03f0140940a3090c603b0110250440a10970c10420fe0470c10400f60000000d80930fe0c00e805907e03f0890100e80bd00000e00400da000000010101010000000000e60ab03f0140830a3090c60b901102504403e0c70c10420ab01f0bb0400160100000d80930fe0c00e805907e03f0890100e80bd00000e00400da00000001010101000000000060ac03f0140700a3090c60f10120250440960ec0c10420310980b50400360100000d80930fe0c00e805907e03f0890100e80bd00000e00400da000000010101010000000000260ac03f01404c0a3090c60e90130250440f8070c204203f0320b10400560100000d80930fe0c00e805907e03f0890100e80bd00000e00400da000000010101010000000000460ac03f0140280a3090c60cf0140250440230190c20420a90cd0ad0400760100000d80930fe0c00e805907e03f0890100e80bd00000e00400c900000001010100000000000720ac03f0140190a3090c60270160250440330200c204202706d0ad0400a20100000da000000010101010000000000fe0ac03f0140960a0090c60fc0e50240440be06d0c2042036070a9040011000000000000000680c301d03f04109c0490bf00000e00400da000000010101010000000000200ad03f014000a0090c60fd0d90240440530620c20420700c10a4040033000000000000000680c301d03f04109c0490bf00000e00400da000000010101010000000000410ad03f01406e09f090c60580ce02404405204c0c20420fb0fa09f040054000000000000000680c301d03f04109c0490bf00000e00400da000000010101010000000000630ad03f0140d809e090c60590c202404406702a0c20420b701509c040076000000000000000680c301d03f04109c0490bf00000e00400da000000010101010000000000960ad03f0140f609d090c605b0b002404401e0e20c104209f0500980400a9000000000000000680c301d03f04109c0490bf00000e00400da000000010101010000000000c80ad03f01401a09d090c60b709e0240440500820c10420dd0cb0940400db000000000000000680c301d03f04109c0490bf00000e00400c900000001010100000000000320ae03f01404409b090c60320790240440260640c00420b20ab0940400450100000da00000001010100000000000910ae03f01407e09b090c60ce04e0240440260640c00420c00450900400450100000da00000001010100000000000c30ae03f0140d809b090c60270390240440260640c004205104008c0400450100000da00000001010100000000000ee0af03f0140d09f090c607d0bd0230440260640c00420610da0870400450100000da00000001010100000000000e0b003f01407b09f090c60e70b00230440260640c004201d0f50830400450100000da00000001010100000000000710b003f01401d0a1090c601508d0230440260640c00420870900800400450100000da00000001010100000000000a10b003f014030a2090c602707d0230440260640c004203809807a0400450100000bb000000010101010000000000f30b003f0140aa0a3090c60a30630230440260640c004208a01707a040000000000d80930fe0c00d507a0380bf0cd07d0310bf00000e00400da000000010101010000000000740b203f01406f0ab090c60d0ec0220440550a80c304205d04e0730400810100000d80930fe0c00d507a0380bf0cd07d0310bf00000e0040082010000034037010e201000300f10ee000000010101030000000000680b403f0140850b5090c60bf0500220440fe05c0bf04208c08606d0400750300000d80930fe0c00d507a0380bf0cd07d0310bf00000e00400c900000001010100000000000e30b403f0140fe0b7090c60a902a0220440320d60bc04208c08606d0400f00300000ee00000001010100000000000590b603f0140cf0c0090c60480d00210440cd0a50bc04208c08606d0400f00300000b40000000ba0a00000ee000000010101000000000004d0b803f0140990cc090c60730570210440da0970bc04208c08606d0400f00300000ee00000001010100000000000410ba03f0140630d8090c609f0de0200440700920bc04208c08606d0400f0030000095000000030000000ff0ff0ff0ff04806506106c04206f0740905200095000000030000000ff0ff0ff0ff06806204306f06d06d07309049000ee00000001010100000000000350bc03f01402d0e4090c60cb06502004409a08a0bc04208c08606d0400f00300000ee00000001010100000000000290be03f0140f70ef090c60f60ec01f0440740990bc04208c08606d0400f00300000b700000001010000000000000fa0be03f0140e40f4090c60750ba01f04403609e0bc04208c08606d0400f0030000095000000030000000ff0ff0ff0ff04806506106c04206f0740905303a03302e03302e03502e03403a04e00095000000040000000ff0ff0ff0ff04806506106c04206f0740904700095000000070000000ff0ff0ff0ff0410630740004806506106c04206f0740904803a03302e03302e03502e03400091030000060000000c70c803f0140f6040000091030000070000000d20ef03f014091030000080000000df0160400140f60400000e7020000060680be0f702a0cf01a06b0f408707309e0b20b30d60670ca06704d07d04e0ad0fd0008803d0cf03a0cf0300180820a60e029091030000090000000203e0400140910300000a000000060650400140f6040000')
	for i in range(len(data)):
		try:
			header = ClientHeader().parse(data[i:])
			packet = parser.parse(data[i:], header)
			print(parser.parser(packet.header.opcode).build(packet))
			print(f'{packet=}')
		except Exception as e:
			pass


async def run_client_server_protocol_sanity_test(client, server, packet, **params):
	packet_name = None
	for name, var in globals().items():
		if var == packet:
			packet_name = name

	if packet_name is None:
		raise ValueError('Unable to determine packet name')

	print(f'{packet_name=}')
	send = getattr(client, f'send_{packet_name}')
	await send(**params)

	result = await server.next_decrypted_packet()
	for key, value in params.items():
		check = getattr(result, key)
		print(f'compare: {key=} {packet_name=} {check=} vs {value=}')
		assert check == value


async def run_server_client_protocol_sanity_test(server, client, packet, **params):
	packet_name = None
	for name, var in globals().items():
		if var == packet:
			packet_name = name

	if packet_name is None:
		raise ValueError('Unable to determine packet name')

	send = getattr(server, f'send_{packet_name}')
	await send(**params)

	result = await client.next_decrypted_packet()
	for key, value in params.items():
		check = getattr(result, key)
		assert check == value


async def test_protocol_packet_fns():
	session_key = 887638991071640811242800621506026194914017482863646559938463468713468253926173117812986327918380
	(client_stream, server_stream) = trio.testing.memory_stream_pair()

	client = WorldClientProtocol(client_stream, session_key=session_key)
	await client.send_CMSG_AUTH_SESSION(ac_login['username'], 1, 2, 3)

	server = WorldServerProtocol(server_stream, session_key=session_key)
	auth_session = await server.receive_CMSG_AUTH_SESSION()
	assert auth_session.header.opcode == Opcode.CMSG_AUTH_SESSION
	assert auth_session.build == 12340
	assert auth_session.login_server_id == 0
	assert auth_session.account_name == ac_login['username'].upper()
	assert auth_session.client_seed == 1
	assert auth_session.account_hash == 2

	cmsg_tests = [
		(CMSG_PING, dict(id=10, latency=60)),
		(CMSG_GUILD_INFO_TEXT, dict(info='Guild info test')),
		(CMSG_GUILD_ROSTER, dict()),
		(CMSG_GET_MAIL_LIST, dict(mailbox=Guid(0xF11002FC1301873C))),
		(CMSG_AUCTION_LIST_OWNER_ITEMS, dict(auctioneer=Guid(0xF1300021DE01375A), list_start=0)),
		(CMSG_AUCTION_LIST_PENDING_SALES, dict(auctioneer=Guid(0xF1300021DE01375A))),
		(CMSG_AUCTION_PLACE_BID, dict(auctioneer=Guid(0xF1300021DE01375A), auction_id=100, price=240000)),
		(CMSG_AUCTION_SELL_ITEM, dict(
			auctioneer=Guid(0xF1300021DE01375A),
			bid=100000, buyout=200000, expiry_time=24,
			auction_items=[
				AuctionSellData.parse(AuctionSellData.build(dict(guid=Guid(0x1), count=7))),
				AuctionSellData.parse(AuctionSellData.build(dict(guid=Guid(0x7), count=1))),
			])),
		(CMSG_AUCTION_LIST_ITEMS, dict(
			auctioneer=Guid(0xF1300021DE01375A), search_term='Bread',
			list_start=0, min_level=0, max_level=80,
			slot_id=0, category=0, subcategory=0,
			rarity=0, usable=False, is_full=True
		)),
		(CMSG_WHO, dict(
			name='Horse',
			min_level=1, max_level=80,
		)),
		# (CMSG_WHOIS, dict(
		#     name='Horsemo'
		# )),
	]

	smsg_tests = [
		(SMSG_ADDON_INFO, dict(data=bytes([1] * 0x7FFF))),
		(SMSG_NAME_QUERY_RESPONSE, dict(
			guid=Guid(0x7), found=True,
			info=NameInfo.parse(NameInfo.build(dict(
				name='Pont', realm_name='Icecrown',
				race=Race.human, gender=Gender.male,
				combat_class=CombatClass.rogue
			)))
		)),
		(SMSG_AUTH_RESPONSE, dict(
			response=AuthResponse.ok, expansion=Expansion.wotlk,
			billing=construct.Container(time_left=10, plan=0, time_rested=0),
			queue_position=None
		)),
	]

	for test in cmsg_tests:
		await run_client_server_protocol_sanity_test(client, server, test[0], **test[1])

	for test in smsg_tests:
		await run_server_client_protocol_sanity_test(server, client, test[0], **test[1])
