import json
import pytest
import os

from wlink.cryptography.srp import sha1, sha_interleave, WoWSrpClient


def load_test_servers(filename: str):
    with open(filename) as f:
        return json.load(f)


def run_login_test(
    login: dict,
    expected_proof_hash: int,
    server_public: int,
    prime: int,
    salt: int,
    client_private: int,
    generator: int = 7,
):

    srp = WoWSrpClient(
        username=login["username"],
        password=login["password"],
        prime=prime,
        generator=generator,
        client_private=client_private,
    )

    srp.process(server_public=server_public, salt=salt)
    if srp.session_proof_hash != expected_proof_hash:
        pytest.fail(
            f"Expected proof hash does not match wow.auth.srp's proof hash\nExpected: {expected_proof_hash}, Actual: {srp.session_proof_hash}"
        )


logins_filename = os.environ.get("WLINK_TEST_CREDS")
test_servers = load_test_servers(logins_filename)


def test_srp_sha1_1():
    assert (
        sha1(["admin", ":", "password"])
        == sha1("admin", ":", "password")
        == sha1("admin:", "password")
        == sha1("admin", ":password")
        == sha1("admin:password")
    )

    assert sha1("hello there", out=hex) == "6e71b3cac15d32fe2d36c270887df9479c25c640"


def test_sha_interleave_bug():
    # This particular client premaster secret (used to) causes an IndexError to be thrown
    sha_interleave(
        407391322519203461383069596634004513669516857100933963214653502998367330243
    )


def test_trinity_core_login():
    run_login_test(
        login=test_servers["trinity-core-3.3.5"]["account"],
        server_public=29690934590145573207593128186052252288614061230055487511226196652110486395787,
        prime=62100066509156017342069496140902949863249758336000796928566441170293728648119,
        salt=92090571083452222281680040879036827917433471144889767667508809381093896083463,
        client_private=143386892073113346271045296825355365119602324795205856098132479049957622403427006810653616896639308669514885320513042624825577275523311345156882292579472806120577841118102290052948040847318515534261288049316514160095147951671405527775489066400222418481863631312167863930538967927022064010646095222765545969242,
        expected_proof_hash=1022273791007009790071844123884488983605182042497,
    )


def test_pywowd_login():
    run_login_test(
        login=test_servers["pywowd"]["account"],
        server_public=14258767328947894749566906365896286238900139614459273591758139169055674817997,
        prime=62100066509156017342069496140902949863249758336000796928566441170293728648119,
        salt=80214272189838780128605308367486581597145816548177813688284808124909330286083,
        client_private=64508203715239665520431703752410749292647193591541528829789533137087608332372153629842152407282399706999122115471110390795718320784801862673227939593010949975104473298714748431039413826795452979178405398151033243901782352529566226164095298482313419487773933315250727807634955488167021998438525130149375396966,
        expected_proof_hash=347584427798917408689051684261570707171670988375,
    )


def test_dalaran_wow_login():
    run_login_test(
        login=test_servers["dalaran-wow"]["account"],
        server_public=5327411182816106837435406979180737285786139726853136191527341845190539275205,
        prime=62100066509156017342069496140902949863249758336000796928566441170293728648119,
        salt=75954218135756535131599375648428171003648711576985788677494333282652637872477,
        client_private=142306331881552112473697781880088266309781841091867079488688284134573933401176170405324918748000252391877452973782630010428158542302900679526253535605570205519419962222145854004673146475255740977146404636890618168605878600203130553118116832240357927436726039366956193392471085102011382587027215537967955584578,
        expected_proof_hash=1029697174638230702641107647608160888414666047618,
    )


def test_warmane_login():
    run_login_test(
        login=test_servers["warmane-test"]["account"],
        server_public=55690488231000858780701857649579951031964349611442983193164950257944277228053,
        prime=62100066509156017342069496140902949863249758336000796928566441170293728648119,
        salt=68778748443859143698106413526933865317366200068841288095563677217409699100349,
        client_private=112789359930318581274721876596934171923655940616537338286180542442639564021131943782012023864269257885436362496796761143535098066332762393594577895938968713289606117034365805477085125047430255233934288990220404011115269416825714722190494022457748830943890949243128562093212991805363077506150820785437790499700,
        expected_proof_hash=1185480264883442351932109474610753035045451809997,
    )


def test_virtus_wow_login():
    run_login_test(
        login=test_servers["virtus-wow"]["account"],
        server_public=54217754367341159065205545753428985832593715946125427726136808334973725141029,
        prime=62100066509156017342069496140902949863249758336000796928566441170293728648119,
        salt=61069560528995965177970168424575935574858590288505684623497225354871331560237,
        client_private=114627234443812628490607185188719299165493809802110914714768895485011615030421540000634692066561088902886929856587961737914383125656585217790142013320687040529150042246018050836506080815736510864702066040831072752129057158483099123335603302990832422153938870126016642564607918833229316011414748263775938386407,
        expected_proof_hash=1308567560536999282048369105572892150368730548280,
    )


def test_sunwell_login():
    run_login_test(
        login=test_servers["sunwell"]["account"],
        server_public=23143273681852431271872878267972040302338068942707650905236210434275330977632,
        prime=62100066509156017342069496140902949863249758336000796928566441170293728648119,
        salt=66014875462303367649846749205400037496991661879179396078073375407779361851687,
        client_private=24418211582550318511863230250695719324083132964223065017303291744195227482040945814797303936547848579860997494563310456580860825172497678625448603893718612417835505234478173892484093335497809269916556646189093144298912269587459810940305014851363754196862587107146926560423404853300762294467471798218808621952,
        expected_proof_hash=142561147712908648219898979596514382639891293882,
    )


def test_heroes_of_wow_login():
    run_login_test(
        login=test_servers["heroes-of-wow"]["account"],
        server_public=23489583226320365042859210581701830601688792909117326146396960888883187971645,
        prime=62100066509156017342069496140902949863249758336000796928566441170293728648119,
        salt=81612925147984493265267691933090992552390268212238483835435855808910099210071,
        client_private=95906860445237528169797529927651859811770430164050380715896424175762242117400330752501525232812188068385940220286432555295762620483380651263322855046353439291960984833197209867342712161053140556209174098010981657371874043755311182552381082591082487507032940894411436215135666250982117048757277066062176847472,
        expected_proof_hash=1128318481360063973755374354955528355556150168959,
    )
